---
export interface Props {
  title?: string;
  subtitle?: string;
  description?: string;
  primaryCTA?: string;
  secondaryCTA?: string;
  primaryCTALink?: string;
  secondaryCTALink?: string;
}

const {
  title = "Starten Sie noch heute Ihre KI-Transformation",
  subtitle = "Kostenlose Strategieberatung",
  description = "Vereinbaren Sie Ihr kostenloses Strategiegespräch und erfahren Sie, wie KI-Automatisierung Ihr Unternehmen zum Marktführer macht.",
  primaryCTA = "Kostenlose Strategieberatung sichern",
  secondaryCTA = "Oder direkt anrufen: +49 XXX XXXXXXX",
  primaryCTALink = "#contact",
  secondaryCTALink = "tel:+49XXXXXXXXX",
} = Astro.props;
---

<section id="final-cta" class="py-10 sm:py-12 bg-white">
  <div class="max-w-8xl mx-auto px-3 sm:px-4 md:px-6 lg:px-12 xl:px-16">
    <div class="max-w-4xl mx-auto">
      <!-- Header -->
      <div class="text-center mb-12">
        <h2
          class="text-3xl sm:text-4xl md:text-5xl font-bold text-gray-900 mb-4 animate-on-scroll"
        >
          {title}
        </h2>
        <p
          class="text-lg text-gray-600 max-w-2xl mx-auto animate-on-scroll"
          style="transition-delay: 0.15s"
        >
          {description}
        </p>
        <p
          class="text-sm text-gray-500 mt-3 animate-on-scroll"
          style="transition-delay: 0.25s"
        >
          Unverbindlich & kostenfrei • Ohne Risiko
        </p>
      </div>

      <!-- Contact Form -->
      <div
        class="bg-white rounded-xl border border-gray-200 p-6 sm:p-8 md:p-10"
      >
        <!-- Success Message -->
        <div
          id="form-success"
          role="alert"
          aria-live="polite"
          class="hidden mb-6 p-4 bg-green-50 border border-green-200 rounded-lg"
        >
          <div class="flex items-center">
            <svg
              class="w-5 h-5 text-green-500 mr-2"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                clip-rule="evenodd"></path>
            </svg>
            <div>
              <h3 class="font-semibold text-green-800">
                Vielen Dank für Ihre Anfrage!
              </h3>
              <p class="text-green-700 mt-1">
                Wir werden uns innerhalb von 24 Stunden bei Ihnen melden.
              </p>
            </div>
          </div>
        </div>

        <!-- Error Messages -->
        <div
          id="form-errors"
          role="alert"
          aria-live="polite"
          class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-lg"
        >
          <h3 class="font-semibold text-red-800 mb-2">
            Bitte korrigieren Sie folgende Fehler:
          </h3>
          <ul id="error-list" class="list-disc list-inside text-red-700"></ul>
        </div>

        <form
          action="#"
          method="POST"
          class="space-y-5"
          id="contact-form"
        >
          <fieldset>
            <legend class="sr-only">Kontaktinformationen</legend>

            <!-- Honeypot field for spam protection (hidden from users) -->
            <input
              type="text"
              name="website"
              id="website"
              tabindex="-1"
              autocomplete="off"
              style="position:absolute;left:-9999px;width:1px;height:1px"
              aria-hidden="true"
            />

            <!-- Name Field -->
            <div class="space-y-2">
              <label for="name" class="block text-sm font-medium text-gray-700">
                Name *
              </label>
              <input
                type="text"
                id="name"
                name="name"
                required
                autocomplete="name"
                aria-describedby="name-error"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent transition-all"
                placeholder="Ihr vollständiger Name"
              />
              <div
                id="name-error"
                role="alert"
                aria-live="polite"
                class="text-sm text-red-600 hidden"
              >
              </div>
            </div>

            <!-- Company Field -->
            <div class="space-y-2">
              <label
                for="company"
                class="block text-sm font-medium text-gray-700"
              >
                Unternehmen *
              </label>
              <input
                type="text"
                id="company"
                name="company"
                required
                autocomplete="organization"
                aria-describedby="company-error"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent transition-all"
                placeholder="Ihr Unternehmensname"
              />
              <div
                id="company-error"
                role="alert"
                aria-live="polite"
                class="text-sm text-red-600 hidden"
              >
              </div>
            </div>

            <!-- Email Field -->
            <div class="space-y-2">
              <label
                for="email"
                class="block text-sm font-medium text-gray-700"
              >
                E-Mail *
              </label>
              <input
                type="email"
                id="email"
                name="email"
                required
                autocomplete="email"
                aria-describedby="email-error"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent transition-all"
                placeholder="ihre@email.de"
              />
              <div
                id="email-error"
                role="alert"
                aria-live="polite"
                class="text-sm text-red-600 hidden"
              >
              </div>
            </div>

            <!-- Phone Field -->
            <div class="space-y-2">
              <label
                for="phone"
                class="block text-sm font-medium text-gray-700"
              >
                Telefon
              </label>
              <input
                type="tel"
                id="phone"
                name="phone"
                autocomplete="tel"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent transition-all"
                placeholder="+49 XXX XXXXXXX"
              />
              <div class="text-sm text-red-600 hidden"></div>
            </div>

            <!-- Message Field -->
            <div class="space-y-2">
              <label
                for="message"
                class="block text-sm font-medium text-gray-700"
              >
                Ihre Nachricht
              </label>
              <textarea
                id="message"
                name="message"
                rows="4"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent transition-all resize-none"
                placeholder="Beschreiben Sie kurz Ihr Automatisierungsziel oder Ihre Herausforderung..."
              ></textarea>
            </div>

            <!-- CTA Button -->
            <div class="pt-4">
              <button
                type="submit"
                class="w-full bg-gradient-to-br from-orange-500 to-orange-700 text-white px-8 py-4 rounded-lg hover:from-orange-600 hover:to-orange-800 font-semibold text-lg focus:outline-none focus:ring-4 focus:ring-orange-200 shadow-lg cta-button"
              >
                Kostenloses Strategiegespräch vereinbaren
              </button>
            </div>

            <div class="text-center pt-2">
              <p class="text-xs text-gray-500">
                Mit dem Absenden stimmen Sie unserer
                <a href="/datenschutz" class="underline hover:text-gray-700"
                  >Datenschutzerklärung</a
                > zu.
              </p>
            </div>
          </fieldset>
        </form>
      </div>
    </div>
  </div>

  <style>
    /* Consistent CTA button animation */
    .cta-button {
      transform-origin: center;
      transition:
        transform 0.2s ease,
        background-color 0.2s ease;
      will-change: transform;
      backface-visibility: hidden;
    }

    .cta-button:hover {
      transform: scale(1.02);
    }
  </style>

  <script type="module">
    // Handle contact form submission with spam protection
    document.addEventListener("DOMContentLoaded", function () {
      const form = document.getElementById("contact-form");
      const formErrors = document.getElementById("form-errors");
      const errorList = document.getElementById("error-list");
      const successDiv = document.getElementById("form-success");
      const submitButton = form?.querySelector('button[type="submit"]');

      // Track form load time for spam protection
      const formLoadTime = Date.now();
      const MIN_FORM_TIME = 3000; // 3 seconds minimum

      // Store original button text
      const originalButtonText = submitButton?.textContent || "";

      // Clear messages when user starts typing
      const formInputs = form?.querySelectorAll("input, textarea");
      formInputs?.forEach((input) => {
        input.addEventListener("input", () => {
          formErrors?.classList.add("hidden");
          successDiv?.classList.add("hidden");
          errorList.innerHTML = "";
        });
      });

      // Handle form submission
      if (form) {
        form.addEventListener("submit", async function (e) {
          e.preventDefault();

          // Reset error states
          formErrors.classList.add("hidden");
          errorList.innerHTML = "";

          // Get form fields
          const name = document.getElementById("name");
          const company = document.getElementById("company");
          const email = document.getElementById("email");
          const phone = document.getElementById("phone");
          const message = document.getElementById("message");
          const honeypot = document.getElementById("website");

          // Client-side validation
          let hasErrors = false;
          const errors = [];

          // Validate name
          if (!name.value.trim()) {
            errors.push("Bitte geben Sie Ihren Namen ein");
            document.getElementById("name-error").textContent =
              "Bitte geben Sie Ihren Namen ein";
            document.getElementById("name-error").classList.remove("hidden");
            hasErrors = true;
          } else {
            document.getElementById("name-error").classList.add("hidden");
          }

          // Validate company
          if (!company.value.trim()) {
            errors.push("Bitte geben Sie Ihren Unternehmensnamen ein");
            document.getElementById("company-error").textContent =
              "Bitte geben Sie Ihren Unternehmensnamen ein";
            document.getElementById("company-error").classList.remove("hidden");
            hasErrors = true;
          } else {
            document.getElementById("company-error").classList.add("hidden");
          }

          // Validate email
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!email.value.trim() || !emailRegex.test(email.value.trim())) {
            errors.push("Bitte geben Sie eine gültige E-Mail-Adresse ein");
            document.getElementById("email-error").textContent =
              "Bitte geben Sie eine gültige E-Mail-Adresse ein";
            document.getElementById("email-error").classList.remove("hidden");
            hasErrors = true;
          } else {
            document.getElementById("email-error").classList.add("hidden");
          }

          // Spam protection: Check honeypot field
          if (honeypot && honeypot.value.trim() !== "") {
            console.warn("Spam detected: honeypot field filled");
            return; // Silent fail for bots
          }

          // Spam protection: Check time since form load
          const timeSinceLoad = Date.now() - formLoadTime;
          if (timeSinceLoad < MIN_FORM_TIME) {
            errors.push(
              "Bitte nehmen Sie sich einen Moment Zeit, um das Formular auszufüllen",
            );
            hasErrors = true;
          }

          // If there are client-side errors, show them and stop
          if (hasErrors) {
            formErrors.classList.remove("hidden");
            errors.forEach((error) => {
              const li = document.createElement("li");
              li.textContent = error;
              errorList.appendChild(li);
            });
            return;
          }

          // Show loading state
          if (submitButton) {
            submitButton.disabled = true;
            submitButton.textContent = "Wird gesendet...";
          }

          try {
            // Prepare payload
            const payload = {
              name: name.value.trim(),
              company: company.value.trim(),
              email: email.value.trim(),
              phone: phone?.value.trim() || "",
              message: message?.value.trim() || "",
              timestamp: new Date().toISOString(),
              userAgent: navigator.userAgent,
              source: "final_cta",
            };

            // TODO: Replace with your n8n webhook URL
            const webhookUrl =
              "https://automation.codariq.de/webhook/YOUR_WEBHOOK_ID_HERE";

            // Send to n8n webhook
            const response = await fetch(webhookUrl, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Basic YWRtaW46cmF6eG9jLWtZenhvdy1qZWpidTk=",
              },
              body: JSON.stringify(payload),
            });

            const result = await response.json();

            // Handle response based on status code
            if (response.status === 200) {
              // Success - Lead accepted
              successDiv.classList.remove("hidden");
              form.style.display = "none";

              // Auto-hide success message after 5 seconds
              setTimeout(() => {
                successDiv.classList.add("hidden");
              }, 5000);
            } else if (response.status === 400) {
              // Validation error - missing required fields
              errors.push(
                "Bitte füllen Sie alle Pflichtfelder korrekt aus.",
              );
              formErrors.classList.remove("hidden");
              const li = document.createElement("li");
              li.textContent = errors[0];
              errorList.appendChild(li);
            } else if (response.status === 403) {
              // Spam detected
              console.warn("Spam detected by server");
              return; // Silent fail
            } else if (response.status === 429) {
              // Too many requests / Rate limit
              errors.push(
                "Zu viele Anfragen. Bitte versuchen Sie es in einigen Minuten erneut.",
              );
              formErrors.classList.remove("hidden");
              const li = document.createElement("li");
              li.textContent = errors[0];
              errorList.appendChild(li);
            } else {
              // Other errors
              errors.push(
                "Es ist ein Fehler aufgetreten. Bitte versuchen Sie es erneut.",
              );
              formErrors.classList.remove("hidden");
              const li = document.createElement("li");
              li.textContent = errors[0];
              errorList.appendChild(li);
            }

            // Auto-hide error messages after 5 seconds
            if (errors.length > 0) {
              setTimeout(() => {
                formErrors.classList.add("hidden");
              }, 5000);
            }
          } catch (error) {
            console.error("Form submission error:", error);
            formErrors.classList.remove("hidden");
            const li = document.createElement("li");
            li.textContent =
              "Es ist ein Netzwerkfehler aufgetreten. Bitte überprüfen Sie Ihre Internetverbindung.";
            errorList.appendChild(li);

            // Auto-hide after 5 seconds
            setTimeout(() => {
              formErrors.classList.add("hidden");
            }, 5000);
          } finally {
            // Reset button state
            if (submitButton) {
              submitButton.disabled = false;
              submitButton.textContent = originalButtonText;
            }
          }
        });
      }
    });
  </script>
</section>
