---
export interface Props {
  title?: string;
  subtitle?: string;
  description?: string;
  primaryCTA?: string;
  secondaryCTA?: string;
  primaryCTALink?: string;
  secondaryCTALink?: string;
}

const {
  title = "Lass uns deine Abläufe spürbar entlasten!",
  description = "Schildere mir kurz deine aktuelle Situation. In 30 Minuten finden wir ein bis zwei Stellen, an denen Automatisierungen dir konkret Zeit, Nerven und Routinearbeit abnehmen kann.",
  primaryCTA = "Termin anfragen",
  primaryCTALink = "#contact",
} = Astro.props;
---

<section id="final-cta" class="py-10 sm:py-12 relative overflow-hidden isolate">
  <div class="absolute inset-0 z-0 pointer-events-none" aria-hidden="true">
	    <img
	      src="/images/final_cta.webp"
	      alt=""
	      class="w-full h-full object-cover scale-90 opacity-100"
	      style="filter: saturate(1.35) contrast(1.05);"
	      loading="lazy"
	      decoding="async"
	    />
	    <!-- <div class="absolute inset-0 bg-white/20"></div> -->
	  </div>
  <div class="relative z-10 max-w-8xl mx-auto px-3 sm:px-4 md:px-6 lg:px-12 xl:px-16">
    <div class="max-w-4xl mx-auto">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 items-start">
        <!-- Copy -->
        <div class="text-center lg:text-left mb-10 lg:mb-0">
          <h2 class="section-title mb-4 animate-on-scroll">
            {title}
          </h2>
	          <p
	            class="body-muted text-gray-900 font-medium max-w-3xl mx-auto lg:mx-0 animate-on-scroll"
	            style="transition-delay: 0.15s"
	          >
	            {description}
	          </p>
          <p
            class="text-sm mt-4 animate-on-scroll"
            style="transition-delay: 0.25s; font-weight: 800 !important;"
          >
            Unverbindlich • Antwort innerhalb von 24 Stunden
          </p>
          <a
            href="https://calendly.com/kontakt-codariq/30min"
            onclick="Calendly.initPopupWidget({url: 'https://calendly.com/kontakt-codariq/30min'});return false;"
            class="hidden lg:inline-flex mt-6 w-full sm:w-auto items-center justify-center gap-2 rounded-lg border border-gray-300 bg-white/80 px-6 py-3 text-base font-semibold text-gray-900 shadow-sm backdrop-blur-sm hover:bg-white hover:border-gray-400 focus:outline-none focus:ring-4 focus:ring-[color:var(--color-cta-primary-ring)]"
            aria-label="30 min Potenzialgespräch über Calendly buchen"
          >
            <svg
              aria-hidden="true"
              viewBox="0 0 24 24"
              class="h-5 w-5 flex-none"
            >
              <circle cx="12" cy="12" r="12" fill="#006BFF"></circle>
              <text
                x="12"
                y="16.5"
                text-anchor="middle"
                font-size="14"
                font-family="system-ui, -apple-system, Segoe UI, Roboto, sans-serif"
                font-weight="800"
                fill="white"
              >
                C
              </text>
            </svg>
            <span>30 min Potenzialgespräch</span>
            <span class="text-xs font-bold text-gray-600">(Calendly)</span>
          </a>
        </div>

        <!-- Contact Form -->
        <div
          class="bg-white rounded-xl border border-gray-200 p-6 sm:p-8 md:p-10"
        >
        <form
          action="#"
          method="POST"
          class="space-y-5"
          id="contact-form"
        >
          <fieldset>
            <legend class="sr-only">Kontaktinformationen</legend>

            <!-- Honeypot field for spam protection (hidden from users) -->
            <input
              type="text"
              name="website"
              id="website"
              tabindex="-1"
              autocomplete="off"
              style="position:absolute;left:-9999px;width:1px;height:1px"
              aria-hidden="true"
            />

            <!-- Name Field -->
            <div class="space-y-2">
              <label for="name" class="block text-sm font-medium text-gray-700">
                Name *
              </label>
              <input
                type="text"
                id="name"
                name="name"
                required
                autocomplete="name"
                aria-describedby="name-error"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent transition-all"
                placeholder="Dein Name"
              />
              <div
                id="name-error"
                role="alert"
                aria-live="polite"
                class="text-sm text-red-600 hidden"
              >
              </div>
            </div>

            <!-- Company Field -->
            <div class="space-y-2">
              <label
                for="company"
                class="block text-sm font-medium text-gray-700"
              >
                Unternehmen oder Tätigkeit *
              </label>
              <input
                type="text"
                id="company"
                name="company"
                required
                autocomplete="organization"
                aria-describedby="company-error"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent transition-all"
                placeholder="Firma oder Selbstständig"
              />
              <div
                id="company-error"
                role="alert"
                aria-live="polite"
                class="text-sm text-red-600 hidden"
              >
              </div>
            </div>

            <!-- Email Field -->
            <div class="space-y-2">
              <label
                for="email"
                class="block text-sm font-medium text-gray-700"
              >
                E-Mail *
              </label>
              <input
                type="email"
                id="email"
                name="email"
                required
                autocomplete="email"
                aria-describedby="email-error"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent transition-all"
                placeholder="dein@email.de"
              />
              <div
                id="email-error"
                role="alert"
                aria-live="polite"
                class="text-sm text-red-600 hidden"
              >
              </div>
            </div>

            <!-- Phone Field -->
            <div class="space-y-2">
              <label
                for="phone"
                class="block text-sm font-medium text-gray-700"
              >
                Telefon
              </label>
              <input
                type="tel"
                id="phone"
                name="phone"
                autocomplete="tel"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent transition-all"
                placeholder="+49 XXX XXXXXXX"
              />
              <div class="text-sm text-red-600 hidden"></div>
            </div>

            <!-- Message Field -->
            <div class="space-y-2">
              <label
                for="message"
                class="block text-sm font-medium text-gray-700"
              >
                Deine Nachricht
              </label>
              <textarea
                id="message"
                name="message"
                rows="4"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent transition-all resize-none"
                placeholder="Wobei soll dir Automatisierung helfen? Zum Beispiel Postfach, Leads, Dokumente oder Backoffice..."
              ></textarea>
            </div>

            <!-- CTA Button -->
            <div class="pt-4">
              <button
                type="submit"
                class="w-full bg-gradient-to-br from-[color:var(--color-cta-primary-from)] to-[color:var(--color-cta-primary-to)] text-white px-8 py-4 rounded-lg hover:from-[color:var(--color-cta-primary-hover)] hover:to-[color:var(--color-cta-primary-to)] font-semibold text-lg focus:outline-none focus:ring-4 focus:ring-[color:var(--color-cta-primary-ring)] shadow-lg cta-button"
              >
                <span class="cta-button-text">{primaryCTA}</span>
              </button>
            </div>
            <a
              href="https://calendly.com/kontakt-codariq/30min"
              onclick="Calendly.initPopupWidget({url: 'https://calendly.com/kontakt-codariq/30min'});return false;"
              class="lg:hidden mt-3 w-full rounded-lg border border-gray-300 bg-white px-6 py-3 text-base font-semibold text-gray-900 shadow-sm hover:bg-gray-50 hover:border-gray-400 focus:outline-none focus:ring-4 focus:ring-[color:var(--color-cta-primary-ring)]"
              aria-label="30 min Potenzialgespräch über Calendly buchen"
            >
              <span class="inline-flex w-full items-center justify-center gap-2">
                <svg
                  aria-hidden="true"
                  viewBox="0 0 24 24"
                  class="h-5 w-5 flex-none"
                >
                  <circle cx="12" cy="12" r="12" fill="#006BFF"></circle>
                  <text
                    x="12"
                    y="16.5"
                    text-anchor="middle"
                    font-size="14"
                    font-family="system-ui, -apple-system, Segoe UI, Roboto, sans-serif"
                    font-weight="800"
                    fill="white"
                  >
                    C
                  </text>
                </svg>
                <span>30 min Potenzialgespräch</span>
                <span class="text-xs font-bold text-gray-600">(Calendly)</span>
              </span>
            </a>

            <!-- Message Container (fixed height prevents layout shift) -->
            <div class="mt-4" style="min-height: 64px">
              <!-- Success Message -->
              <div
                id="form-success"
                role="alert"
                aria-live="polite"
                class="hidden p-4 bg-green-50 border border-green-200 rounded-lg"
              >
                <div class="flex items-center">
                  <svg
                    class="w-5 h-5 text-green-500 mr-2 flex-shrink-0"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                      clip-rule="evenodd"
                    ></path>
                  </svg>
                  <div>
                    <h3 class="font-semibold text-green-800 text-sm sm:text-base">
                      Danke! Ich melde mich bei dir.
                    </h3>
                    <p class="text-green-700 mt-1 text-xs sm:text-sm">
                      Du bekommst innerhalb von 24 Stunden eine Rückmeldung.
                    </p>
                  </div>
                </div>
              </div>

              <!-- Error Messages -->
              <div
                id="form-errors"
                role="alert"
                aria-live="polite"
                class="hidden p-4 bg-red-50 border border-red-200 rounded-lg"
              >
                <h3 class="font-semibold text-red-800 mb-2 text-sm sm:text-base">
                  Bitte korrigiere Folgendes:
                </h3>
                <ul
                  id="error-list"
                  class="list-disc list-inside text-red-700 text-xs sm:text-sm"
                ></ul>
              </div>
            </div>

            <div class="text-center pt-2">
              <p class="text-xs text-gray-500">
                Mit dem Absenden stimmst du unserer
                <a href="/datenschutz" class="underline hover:text-gray-700"
                  >Datenschutzerklärung</a
                > zu.
              </p>
            </div>
          </fieldset>
        </form>
      </div>
      </div>
    </div>
  </div>

  <style>
    /* Success state for CTA button */
    .cta-button.success {
      background: linear-gradient(to bottom right, #22c55e, #16a34a) !important;
    }

    /* Text fade animation */
    .cta-button-text {
      transition: opacity 0.3s ease;
    }

    .cta-button-text.fade-out {
      opacity: 0;
    }
  </style>

  <script type="module">
    // Handle contact form submission with spam protection
    document.addEventListener("DOMContentLoaded", function () {
      const form = document.getElementById("contact-form");
      const formErrors = document.getElementById("form-errors");
      const errorList = document.getElementById("error-list");
      const successDiv = document.getElementById("form-success");
      const submitButton = form?.querySelector('button[type="submit"]');

      // Track form load time for spam protection
      const formLoadTime = Date.now();
      const MIN_FORM_TIME = 3000; // 3 seconds minimum

      // Store original button text
      const originalButtonText = submitButton?.querySelector('.cta-button-text')?.textContent || "";

      // Clear messages when user starts typing
      const formInputs = form?.querySelectorAll("input, textarea");
      formInputs?.forEach((input) => {
        input.addEventListener("input", () => {
          formErrors?.classList.add("hidden");
          successDiv?.classList.add("hidden");
          errorList.innerHTML = "";
        });
      });

      // Handle form submission
      if (form) {
        form.addEventListener("submit", async function (e) {
          e.preventDefault();

          // Reset error states
          formErrors.classList.add("hidden");
          errorList.innerHTML = "";

          // Get form fields
          const name = document.getElementById("name");
          const company = document.getElementById("company");
          const email = document.getElementById("email");
          const phone = document.getElementById("phone");
          const message = document.getElementById("message");
          const honeypot = document.getElementById("website");

          // Client-side validation
          let hasErrors = false;
          const errors = [];

          // Validate name
          if (!name.value.trim()) {
            errors.push("Bitte gib deinen Namen ein");
            document.getElementById("name-error").textContent =
              "Bitte gib deinen Namen ein";
            document.getElementById("name-error").classList.remove("hidden");
            hasErrors = true;
          } else {
            document.getElementById("name-error").classList.add("hidden");
          }

          // Validate company
          if (!company.value.trim()) {
            errors.push("Bitte gib dein Unternehmen oder deine Tätigkeit ein");
            document.getElementById("company-error").textContent =
              "Bitte gib dein Unternehmen oder deine Tätigkeit ein";
            document.getElementById("company-error").classList.remove("hidden");
            hasErrors = true;
          } else {
            document.getElementById("company-error").classList.add("hidden");
          }

          // Validate email
          const isValidEmail = (email: string) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
          if (!email.value.trim() || !isValidEmail(email.value.trim())) {
            errors.push("Bitte gib eine gültige E Mail Adresse ein");
            document.getElementById("email-error").textContent =
              "Bitte gib eine gültige E Mail Adresse ein";
            document.getElementById("email-error").classList.remove("hidden");
            hasErrors = true;
          } else {
            document.getElementById("email-error").classList.add("hidden");
          }

          // Spam protection: Check honeypot field
          if (honeypot && honeypot.value.trim() !== "") {
            console.warn("Spam detected: honeypot field filled");
            return; // Silent fail for bots
          }

          // Spam protection: Check time since form load
          const timeSinceLoad = Date.now() - formLoadTime;
          if (timeSinceLoad < MIN_FORM_TIME) {
            errors.push(
              "Bitte nimm dir einen Moment Zeit, um das Formular auszufüllen",
            );
            hasErrors = true;
          }

          // If there are client-side errors, show them and stop
          if (hasErrors) {
            formErrors.classList.remove("hidden");
            errors.forEach((error) => {
              const li = document.createElement("li");
              li.textContent = error;
              errorList.appendChild(li);
            });
            return;
          }

          // Show loading state
          if (submitButton) {
            submitButton.disabled = true;
            const buttonText = submitButton.querySelector('.cta-button-text');
            if (buttonText) {
              buttonText.textContent = "Wird gesendet...";
            }
          }

          let response; // Declare outside try block for finally access
          try {
            // Prepare payload
            const payload = {
              name: name.value.trim(),
              company: company.value.trim(),
              email: email.value.trim(),
              phone: phone?.value.trim() || "",
              message: message?.value.trim() || "",
              timestamp: new Date().toISOString(),
              userAgent: navigator.userAgent,
              source: "final_cta",
            };

            // n8n webhook for contact form submissions
            const webhookUrl = import.meta.env.PUBLIC_N8N_WEBHOOK_URL;
            const webhookAuth = import.meta.env.PUBLIC_N8N_WEBHOOK_AUTH;
            if (!webhookUrl || !webhookAuth) {
              throw new Error("Webhook not configured");
            }

            // Send to n8n webhook
            response = await fetch(webhookUrl, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: webhookAuth,
              },
              body: JSON.stringify(payload),
            });

            // Parse JSON response (ignore errors for successful status codes)
            let result = {};
            try {
              result = await response.json();
            } catch (e) {
              // Response is not JSON - ignore for successful responses
              console.log("Response is not JSON");
            }

            // Handle response based on status code
            if (response.status === 200) {
              // Success - Lead accepted
              successDiv.classList.remove("hidden");

              // Update button to success state with smooth fade animation
              const buttonText = submitButton.querySelector('.cta-button-text');

              // Fade out text
              buttonText.classList.add('fade-out');

              // Wait for fade out, then update content and fade in
              setTimeout(() => {
                buttonText.textContent = "✓ Gesendet!";
                submitButton.classList.add('success');
                submitButton.disabled = true;

                // Fade text back in
                buttonText.classList.remove('fade-out');
              }, 300); // Match CSS transition duration
            } else if (response.status === 400) {
              // Validation error - missing required fields
              errors.push(
                "Bitte füll alle Pflichtfelder korrekt aus.",
              );
              formErrors.classList.remove("hidden");
              const li = document.createElement("li");
              li.textContent = errors[0];
              errorList.appendChild(li);
            } else if (response.status === 403) {
              // Spam detected
              console.warn("Spam detected by server");
              return; // Silent fail
            } else if (response.status === 429) {
              // Too many requests / Rate limit
              errors.push(
                "Zu viele Anfragen. Bitte versuch es in ein paar Minuten erneut.",
              );
              formErrors.classList.remove("hidden");
              const li = document.createElement("li");
              li.textContent = errors[0];
              errorList.appendChild(li);
            } else {
              // Other errors
              errors.push(
                "Es ist ein Fehler passiert. Bitte versuch es erneut.",
              );
              formErrors.classList.remove("hidden");
              const li = document.createElement("li");
              li.textContent = errors[0];
              errorList.appendChild(li);
            }

            // Auto-hide error messages after 5 seconds
            if (errors.length > 0) {
              setTimeout(() => {
                formErrors.classList.add("hidden");
              }, 5000);
            }
          } catch (error) {
            console.error("Form submission error:", error);
            formErrors.classList.remove("hidden");
            const li = document.createElement("li");
            li.textContent =
              "Es ist ein Netzwerkfehler passiert. Bitte prüf deine Internetverbindung.";
            errorList.appendChild(li);

            // Auto-hide after 5 seconds
            setTimeout(() => {
              formErrors.classList.add("hidden");
            }, 5000);
          } finally {
            // Reset button state only if not successful
            if (submitButton && response && response.status !== 200) {
              const buttonText = submitButton.querySelector('.cta-button-text');
              submitButton.disabled = false;
              if (buttonText) {
                buttonText.textContent = originalButtonText;
              }
            }
          }
        });
      }
    });
  </script>
</section>
