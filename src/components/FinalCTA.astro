---
export interface Props {
  title?: string;
  subtitle?: string;
  description?: string;
  primaryCTA?: string;
  secondaryCTA?: string;
  primaryCTALink?: string;
  secondaryCTALink?: string;
}

const {
  title = "Starten Sie noch heute Ihre KI-Transformation",
  subtitle = "Kostenlose Strategieberatung",
  description = "Vereinbaren Sie Ihr kostenloses Strategiegespräch und erfahren Sie, wie KI-Automatisierung Ihr Unternehmen zum Marktführer macht.",
  primaryCTA = "Kostenlose Strategieberatung sichern",
  secondaryCTA = "Oder direkt anrufen: +49 XXX XXXXXXX",
  primaryCTALink = "#contact",
  secondaryCTALink = "tel:+49XXXXXXXXX"
} = Astro.props;
---
<section id="final-cta" class="py-10 sm:py-12 bg-white">
  <div class="max-w-8xl mx-auto px-3 sm:px-4 md:px-6 lg:px-12 xl:px-16">
    <div class="max-w-4xl mx-auto">
      
      <!-- Header -->
      <div class="text-center mb-12">
        <h2 class="text-3xl sm:text-4xl md:text-5xl font-bold text-gray-900 mb-4">
          {title}
        </h2>
        <p class="text-lg text-gray-600 max-w-2xl mx-auto">
          {description}
        </p>
        <p class="text-sm text-gray-500 mt-3">
          Unverbindlich & kostenfrei • Ohne Risiko
        </p>
      </div>
      
      <!-- Contact Form -->
      <div class="bg-white rounded-xl border border-gray-200 p-6 sm:p-8 md:p-10">
        <!-- Success Message -->
        <div id="form-success" role="alert" aria-live="polite" class="hidden mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
          <div class="flex items-center">
            <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <div>
              <h3 class="font-semibold text-green-800">Vielen Dank für Ihre Anfrage!</h3>
              <p class="text-green-700 mt-1">Wir werden uns innerhalb von 24 Stunden bei Ihnen melden.</p>
            </div>
          </div>
        </div>
        
        <!-- Error Messages -->
        <div id="form-errors" role="alert" aria-live="polite" class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
          <h3 class="font-semibold text-red-800 mb-2">Bitte korrigieren Sie folgende Fehler:</h3>
          <ul id="error-list" class="list-disc list-inside text-red-700"></ul>
        </div>
        
        <form action="https://formsubmit.co/kontakt@codariq.de" method="POST" class="space-y-5" id="contact-form">
          
          <fieldset>
            <legend class="sr-only">Kontaktinformationen</legend>
            
            <!-- FormSubmit.co Configuration -->
            <input type="hidden" name="_subject" value="Neue Kontaktanfrage von codariq.de">
            <input type="hidden" name="_next" value="https://codariq.de?success=true">
            <input type="hidden" name="_template" value="table">
            <input type="hidden" name="_captcha" value="false">
          
          <!-- Name Field -->
          <div class="space-y-2">
            <label for="name" class="block text-sm font-medium text-gray-700">
              Name *
            </label>
            <input 
              type="text" 
              id="name" 
              name="name" 
              required
              autocomplete="name"
              aria-describedby="name-error"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent transition-all"
              placeholder="Ihr vollständiger Name"
            />
            <div id="name-error" role="alert" aria-live="polite" class="text-sm text-red-600 hidden"></div>
          </div>
          
          <!-- Company Field -->
          <div class="space-y-2">
            <label for="company" class="block text-sm font-medium text-gray-700">
              Unternehmen *
            </label>
            <input 
              type="text" 
              id="company" 
              name="company" 
              required
              autocomplete="organization"
              aria-describedby="company-error"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent transition-all"
              placeholder="Ihr Unternehmensname"
            />
            <div id="company-error" role="alert" aria-live="polite" class="text-sm text-red-600 hidden"></div>
          </div>
          
          <!-- Email Field -->
          <div class="space-y-2">
            <label for="email" class="block text-sm font-medium text-gray-700">
              E-Mail *
            </label>
            <input 
              type="email" 
              id="email" 
              name="email" 
              required
              autocomplete="email"
              aria-describedby="email-error"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent transition-all"
              placeholder="ihre@email.de"
            />
            <div id="email-error" role="alert" aria-live="polite" class="text-sm text-red-600 hidden"></div>
          </div>
          
          <!-- Phone Field -->
          <div class="space-y-2">
            <label for="phone" class="block text-sm font-medium text-gray-700">
              Telefon
            </label>
            <input 
              type="tel" 
              id="phone" 
              name="phone"
              autocomplete="tel"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent transition-all"
              placeholder="+49 XXX XXXXXXX"
            />
            <div class="text-sm text-red-600 hidden"></div>
          </div>
          
          <!-- Message Field -->
          <div class="space-y-2">
            <label for="message" class="block text-sm font-medium text-gray-700">
              Ihre Nachricht
            </label>
            <textarea 
              id="message" 
              name="message" 
              rows="4"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-transparent transition-all resize-none"
              placeholder="Beschreiben Sie kurz Ihr Automatisierungsziel oder Ihre Herausforderung..."
            ></textarea>
          </div>
          
          <!-- CTA Button -->
          <div class="pt-4">
            <button 
              type="submit"
              class="w-full bg-gradient-to-br from-orange-500 to-orange-700 text-white px-8 py-4 rounded-lg hover:from-orange-600 hover:to-orange-800 font-semibold text-lg focus:outline-none focus:ring-4 focus:ring-orange-200 shadow-lg cta-button"
            >
              Kostenloses Strategiegespräch vereinbaren
            </button>
          </div>
          
          <div class="text-center pt-2">
            <p class="text-xs text-gray-500">
              Mit dem Absenden stimmen Sie unserer 
              <a href="/datenschutz" class="underline hover:text-gray-700">Datenschutzerklärung</a> zu.
            </p>
          </div>
          
          </fieldset>
        </form>
      </div>
      
      <!-- Calendly Widget with Loading State -->
      <div class="text-center mt-8">
        <p class="text-gray-600 text-sm mb-6">Oder buchen Sie direkt einen Termin:</p>
        <div class="bg-white rounded-xl p-6 max-w-5xl mx-auto">
          <div id="calendly-container">
            <div class="min-h-[700px] flex flex-col items-center justify-center bg-gray-50 rounded-lg">
              <button 
                id="load-calendly" 
                class="bg-gradient-to-br from-orange-500 to-orange-700 text-white px-6 py-3 rounded-lg hover:from-orange-600 hover:to-orange-800 font-semibold mb-4 min-h-[44px] min-w-[44px] cta-button"
                aria-describedby="calendly-description"
              >
                Terminkalender laden
              </button>
              <p id="calendly-description" class="text-sm text-gray-600 text-center max-w-md">
                Lädt den Calendly-Terminplaner für die direkte Buchung. 
                <a href="https://calendly.com/kontakt-codariq/45min" class="text-blue-600 hover:underline" target="_blank" rel="noopener">
                  Alternativ direkt zu Calendly
                </a>
              </p>
            </div>
          </div>
        </div>
      </div>
      
    </div>
  </div>
</section>

<style>
  /* Consistent CTA button animation */
  .cta-button {
    transform-origin: center;
    transition: transform 0.2s ease, background-color 0.2s ease;
    will-change: transform;
    backface-visibility: hidden;
  }
  
  .cta-button:hover {
    transform: scale(1.02);
  }
</style>

<script type="module">
document.addEventListener('DOMContentLoaded', function() {
  const loadButton = document.getElementById('load-calendly');
  const container = document.getElementById('calendly-container');
  
  if (loadButton && container) {
    // Check cookie consent before loading Calendly
    function hasMarketingConsent() {
      const consent = localStorage.getItem('cookieConsent');
      if (!consent) return false;
      const parsed = JSON.parse(consent);
      return parsed.preferences && parsed.preferences.marketing === true;
    }
    
    // Support both click and keyboard events
    function loadCalendlyWidget() {
      // Check if marketing cookies are allowed
      if (!hasMarketingConsent()) {
        container.innerHTML = `
          <div class="min-h-[700px] flex items-center justify-center bg-gray-50 rounded-lg">
            <div class="text-center max-w-md">
              <svg class="w-16 h-16 text-orange-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
              </svg>
              <h3 class="text-lg font-semibold text-gray-900 mb-2">Cookie-Einwilligung erforderlich</h3>
              <p class="text-gray-600 mb-4">
                Um den Terminkalender zu laden, benötigen wir Ihre Einwilligung für Marketing-Cookies.
              </p>
              <button 
                onclick="document.getElementById('cookie-settings').click()" 
                class="bg-gradient-to-r from-orange-600 to-orange-700 text-white px-4 py-2 rounded-lg hover:from-orange-700 hover:to-orange-800 font-medium"
              >
                Cookie-Einstellungen öffnen
              </button>
            </div>
          </div>
        `;
        return;
      }
      
      // Show loading state
      container.innerHTML = `
        <div class="min-h-[700px] flex items-center justify-center bg-gray-50 rounded-lg">
          <div class="text-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500 mx-auto mb-4"></div>
            <p class="text-gray-600">Terminkalender wird geladen...</p>
          </div>
        </div>
      `;
      
      // Load Calendly widget
      setTimeout(() => {
        // Check if mobile device
        const isMobile = window.innerWidth < 768;
        const height = isMobile ? '580px' : '700px';
        
        // Mobile-optimized parameters
        const baseParams = 'hide_gdpr_banner=1&hide_event_type_details=1&embed_type=Inline';
        const mobileParams = isMobile 
          ? `${baseParams}&embed_domain=${encodeURIComponent(window.location.hostname)}&background_color=ffffff&text_color=111827&primary_color=ea580c`
          : baseParams;
        
        container.innerHTML = `
          <div class="calendly-inline-widget" 
               data-url="https://calendly.com/kontakt-codariq/45min?${mobileParams}" 
               style="min-width:320px;height:${height};width:100%;border-radius:8px;overflow:hidden;"></div>
        `;
        
        // Load Calendly script
        const script = document.createElement('script');
        script.src = 'https://assets.calendly.com/assets/external/widget.js';
        script.async = true;
        document.head.appendChild(script);
      }, 100);
    }
    
    // Add event listeners for both click and keyboard
    loadButton.addEventListener('click', loadCalendlyWidget);
    loadButton.addEventListener('keydown', function(event) {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        loadCalendlyWidget();
      }
    });
  }
});

// Handle form submission and success/error messages
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('contact-form');
  const formErrors = document.getElementById('form-errors');
  const errorList = document.getElementById('error-list');
  const successDiv = document.getElementById('form-success');
  
  // Check for success parameter in URL (from FormSubmit.co redirect)
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('success') === 'true') {
    if (successDiv && form) {
      successDiv.classList.remove('hidden');
      form.style.display = 'none';
      
      // Clean URL first to prevent any hash-based jumping
      window.history.replaceState({}, document.title, window.location.pathname);
      
      // Delay scroll to ensure DOM is ready and no competing scrolls
      setTimeout(() => {
        successDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 100);
    }
  }
  
  // Client-side form validation
  if (form) {
    form.addEventListener('submit', function(e) {
      // Reset error states
      formErrors.classList.add('hidden');
      errorList.innerHTML = '';
      
      // Get required fields
      const name = document.getElementById('name');
      const company = document.getElementById('company');
      const email = document.getElementById('email');
      
      let hasErrors = false;
      const errors = [];
      
      // Validate name
      if (!name.value.trim()) {
        errors.push('Bitte geben Sie Ihren Namen ein');
        document.getElementById('name-error').textContent = 'Bitte geben Sie Ihren Namen ein';
        document.getElementById('name-error').classList.remove('hidden');
        hasErrors = true;
      } else {
        document.getElementById('name-error').classList.add('hidden');
      }
      
      // Validate company
      if (!company.value.trim()) {
        errors.push('Bitte geben Sie Ihren Unternehmensnamen ein');
        document.getElementById('company-error').textContent = 'Bitte geben Sie Ihren Unternehmensnamen ein';
        document.getElementById('company-error').classList.remove('hidden');
        hasErrors = true;
      } else {
        document.getElementById('company-error').classList.add('hidden');
      }
      
      // Validate email
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!email.value.trim() || !emailRegex.test(email.value.trim())) {
        errors.push('Bitte geben Sie eine gültige E-Mail-Adresse ein');
        document.getElementById('email-error').textContent = 'Bitte geben Sie eine gültige E-Mail-Adresse ein';
        document.getElementById('email-error').classList.remove('hidden');
        hasErrors = true;
      } else {
        document.getElementById('email-error').classList.add('hidden');
      }
      
      // If there are errors, prevent form submission and show error messages
      if (hasErrors) {
        e.preventDefault();
        formErrors.classList.remove('hidden');
        errors.forEach(error => {
          const li = document.createElement('li');
          li.textContent = error;
          errorList.appendChild(li);
        });
        formErrors.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    });
  }
});
</script>