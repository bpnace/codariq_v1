---
export interface Props {
  className?: string;
}

const { className = '' } = Astro.props;
---

<!-- Cookie Consent Banner -->
<div
  id="cookie-consent"
  class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-50 transform translate-y-full transition-transform duration-300 ease-in-out"
  data-cookie-banner
  role="dialog"
  aria-labelledby="cookie-consent-title"
  aria-describedby="cookie-consent-description"
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-6">
    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
      <!-- Cookie Icon & Content -->
      <div class="flex items-start gap-3 flex-1">
        <div class="flex-shrink-0 mt-1">
          <svg
            class="w-5 h-5 text-orange-600"
            fill="currentColor"
            viewBox="0 0 20 20"
            aria-hidden="true"
          >
            <path
              fill-rule="evenodd"
              d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
              clip-rule="evenodd"></path>
          </svg>
        </div>

        <div class="flex-1">
          <h3
            id="cookie-consent-title"
            class="font-semibold text-gray-900 text-sm sm:text-base mb-1"
          >
            Cookie-Einstellungen
          </h3>
          <p
            id="cookie-consent-description"
            class="text-xs sm:text-sm text-gray-600 leading-relaxed"
          >
            Wir verwenden notwendige Cookies für die Grundfunktionen unserer
            Website. Für Analysen verwenden wir das datenschutzfreundliche
            <a
              href="https://plausible.io"
              class="text-orange-600 hover:text-orange-700 underline"
              target="_blank"
              rel="noopener">Plausible Analytics</a
            >
            (EU-Server, keine personenbezogenen Daten).
            <a
              href="/cookie-richtlinien"
              class="text-orange-600 hover:text-orange-700 underline"
              >Mehr erfahren</a
            >
          </p>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 w-full sm:w-auto">
        <button
          id="cookie-settings"
          class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2"
          aria-describedby="cookie-consent-description"
        >
          Einstellungen
        </button>

        <button
          id="cookie-accept-necessary"
          class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2"
          aria-describedby="cookie-consent-description"
        >
          Nur notwendige
        </button>

        <button
          id="cookie-accept-all"
          class="px-4 py-2 text-sm font-medium text-white bg-gradient-to-r from-orange-600 to-orange-700 hover:from-orange-700 hover:to-orange-800 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 shadow-sm"
          aria-describedby="cookie-consent-description"
        >
          Alle akzeptieren
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Immediate banner show script -->
<script>
  // Show banner immediately if no consent exists
  (function () {
    if (!localStorage.getItem('cookieConsent')) {
      const banner = document.getElementById('cookie-consent');
      if (banner) {
        banner.classList.remove('translate-y-full');
      }
    }
  })();
</script>

<!-- Cookie Settings Modal -->
<div
  id="cookie-settings-modal"
  class="fixed inset-0 bg-black bg-opacity-50 z-60 hidden items-center justify-center p-4"
  role="dialog"
  aria-labelledby="cookie-settings-title"
  aria-modal="true"
>
  <div
    class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-screen overflow-y-auto"
  >
    <div class="p-6">
      <!-- Modal Header -->
      <div class="flex items-center justify-between mb-6">
        <h2 id="cookie-settings-title" class="text-xl font-bold text-gray-900">
          Cookie-Einstellungen verwalten
        </h2>
        <button
          id="cookie-settings-close"
          class="text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-orange-500 rounded-lg p-1"
          aria-label="Cookie-Einstellungen schließen"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <!-- Cookie Categories -->
      <div class="space-y-6">
        <!-- Necessary Cookies -->
        <div class="border-b border-gray-200 pb-6">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h3 class="font-semibold text-gray-900">Notwendige Cookies</h3>
              <p class="text-sm text-gray-600">
                Erforderlich für die Grundfunktionen der Website
              </p>
            </div>
            <div class="flex items-center">
              <div class="relative">
                <input
                  type="checkbox"
                  id="necessary-cookies"
                  checked
                  disabled
                  class="sr-only"
                />
                <div class="w-11 h-6 bg-orange-600 rounded-full shadow-inner">
                  <div
                    class="w-4 h-4 bg-white rounded-full shadow transform translate-x-6 transition-transform"
                  >
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="text-sm text-gray-600 space-y-2">
            <p>
              <strong>Zweck:</strong> Speicherung Ihrer Cookie-Präferenzen, Session-Management
            </p>
            <p><strong>Dauer:</strong> Session / 1 Jahr</p>
            <p><strong>Cookies:</strong> cookieConsent, sessionId</p>
          </div>
        </div>

        <!-- Analytics Cookies -->
        <div class="border-b border-gray-200 pb-6">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h3 class="font-semibold text-gray-900">Analyse-Cookies</h3>
              <p class="text-sm text-gray-600">
                Plausible Analytics (EU-Server, datenschutzfreundlich)
              </p>
            </div>
            <div class="flex items-center">
              <label class="relative cursor-pointer">
                <input
                  type="checkbox"
                  id="analytics-cookies"
                  class="sr-only analytics-toggle"
                />
                <div
                  class="toggle-bg w-11 h-6 bg-gray-200 rounded-full shadow-inner transition-colors"
                >
                  <div
                    class="toggle-dot w-4 h-4 bg-white rounded-full shadow transform transition-transform"
                  >
                  </div>
                </div>
              </label>
            </div>
          </div>
          <div class="text-sm text-gray-600 space-y-2">
            <p>
              <strong>Zweck:</strong> Anonyme Nutzungsstatistiken, Verbesserung der
              Website
            </p>
            <p><strong>Anbieter:</strong> Plausible Analytics (EU)</p>
            <p><strong>Dauer:</strong> 24 Stunden</p>
            <p>
              <strong>Datenschutz:</strong> Keine personenbezogenen Daten, keine
              IP-Speicherung
            </p>
          </div>
        </div>

        <!-- Marketing Cookies -->
        <div class="pb-6">
          <div class="flex items-center justify-between mb-3">
            <div>
              <h3 class="font-semibold text-gray-900">Marketing-Cookies</h3>
              <p class="text-sm text-gray-600">
                Calendly Widget für Terminbuchungen
              </p>
            </div>
            <div class="flex items-center">
              <label class="relative cursor-pointer">
                <input
                  type="checkbox"
                  id="marketing-cookies"
                  class="sr-only marketing-toggle"
                />
                <div
                  class="toggle-bg w-11 h-6 bg-gray-200 rounded-full shadow-inner transition-colors"
                >
                  <div
                    class="toggle-dot w-4 h-4 bg-white rounded-full shadow transform transition-transform"
                  >
                  </div>
                </div>
              </label>
            </div>
          </div>
          <div class="text-sm text-gray-600 space-y-2">
            <p>
              <strong>Zweck:</strong> Calendly Terminbuchung und -verwaltung
            </p>
            <p><strong>Anbieter:</strong> Calendly LLC (USA)</p>
            <p><strong>Dauer:</strong> Variabel</p>
            <p>
              <strong>Datenschutz:</strong>
              <a
                href="https://calendly.com/privacy"
                class="text-orange-600 hover:text-orange-700 underline"
                target="_blank"
                rel="noopener">Calendly Privacy Policy</a>
            </p>
          </div>
        </div>
      </div>

      <!-- Modal Actions -->
      <div
        class="flex flex-col sm:flex-row gap-3 pt-6 border-t border-gray-200"
      >
        <button
          id="cookie-save-settings"
          class="flex-1 px-6 py-3 bg-gradient-to-r from-orange-600 to-orange-700 text-white font-medium rounded-lg hover:from-orange-700 hover:to-orange-800 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 transition-colors"
        >
          Einstellungen speichern
        </button>
        <button
          id="cookie-accept-all-modal"
          class="px-6 py-3 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors"
        >
          Alle akzeptieren
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Cookie Consent Management
  class CookieConsent {
    constructor() {
      this.consentKey = 'cookieConsent';
      this.init();
    }

    init() {
      // Check if consent was already given
      if (this.hasConsent()) {
        this.hideBanner();
        this.loadApprovedServices();
      }

      this.bindEvents();
    }

    bindEvents() {
      // Banner buttons
      document
        .getElementById('cookie-accept-all')
        ?.addEventListener('click', () => {
          this.acceptAll();
        });

      document
        .getElementById('cookie-accept-necessary')
        ?.addEventListener('click', () => {
          this.acceptNecessary();
        });

      document
        .getElementById('cookie-settings')
        ?.addEventListener('click', () => {
          this.showSettings();
        });

      // Modal buttons
      document
        .getElementById('cookie-settings-close')
        ?.addEventListener('click', () => {
          this.hideSettings();
        });

      document
        .getElementById('cookie-save-settings')
        ?.addEventListener('click', () => {
          this.saveSettings();
        });

      document
        .getElementById('cookie-accept-all-modal')
        ?.addEventListener('click', () => {
          this.acceptAll();
          this.hideSettings();
        });

      // Toggle switches
      document
        .querySelectorAll('.analytics-toggle, .marketing-toggle')
        .forEach(toggle => {
          toggle.addEventListener('change', e => {
            this.updateToggleUI(e.target);
          });
        });

      // Close modal on backdrop click
      document
        .getElementById('cookie-settings-modal')
        ?.addEventListener('click', e => {
          if (e.target.id === 'cookie-settings-modal') {
            this.hideSettings();
          }
        });
    }

    hasConsent() {
      return localStorage.getItem(this.consentKey) !== null;
    }

    getConsent() {
      const consent = localStorage.getItem(this.consentKey);
      return consent ? JSON.parse(consent) : null;
    }

    saveConsent(preferences) {
      const consent = {
        timestamp: new Date().toISOString(),
        preferences: preferences,
      };
      localStorage.setItem(this.consentKey, JSON.stringify(consent));
    }

    showBanner() {
      const banner = document.getElementById('cookie-consent');
      if (banner) {
        banner.style.display = 'block';
        banner.classList.remove('translate-y-full');
      }
    }

    hideBanner() {
      const banner = document.getElementById('cookie-consent');
      if (banner) {
        banner.classList.add('translate-y-full');
        setTimeout(() => {
          banner.style.display = 'none';
        }, 300);
      }
    }

    showSettings() {
      const modal = document.getElementById('cookie-settings-modal');
      if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');

        // Load current preferences
        const consent = this.getConsent();
        if (consent) {
          document.getElementById('analytics-cookies').checked =
            consent.preferences.analytics;
          document.getElementById('marketing-cookies').checked =
            consent.preferences.marketing;

          // Update toggle UI
          this.updateToggleUI(document.getElementById('analytics-cookies'));
          this.updateToggleUI(document.getElementById('marketing-cookies'));
        }
      }
    }

    hideSettings() {
      const modal = document.getElementById('cookie-settings-modal');
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
    }

    updateToggleUI(toggle) {
      const toggleBg = toggle.parentElement.querySelector('.toggle-bg');
      const toggleDot = toggle.parentElement.querySelector('.toggle-dot');

      if (toggle.checked) {
        toggleBg.classList.remove('bg-gray-200');
        toggleBg.classList.add('bg-orange-600');
        toggleDot.classList.add('translate-x-5');
      } else {
        toggleBg.classList.add('bg-gray-200');
        toggleBg.classList.remove('bg-orange-600');
        toggleDot.classList.remove('translate-x-5');
      }
    }

    acceptAll() {
      const preferences = {
        necessary: true,
        analytics: true,
        marketing: true,
      };

      this.saveConsent(preferences);
      this.loadApprovedServices();
      this.hideBanner();
      this.hideSettings();
    }

    acceptNecessary() {
      const preferences = {
        necessary: true,
        analytics: false,
        marketing: false,
      };

      this.saveConsent(preferences);
      this.loadApprovedServices();
      this.hideBanner();
    }

    saveSettings() {
      const preferences = {
        necessary: true,
        analytics: document.getElementById('analytics-cookies').checked,
        marketing: document.getElementById('marketing-cookies').checked,
      };

      this.saveConsent(preferences);
      this.loadApprovedServices();
      this.hideSettings();
      this.hideBanner();
    }

    loadApprovedServices() {
      const consent = this.getConsent();
      if (!consent) return;

      // Load Plausible Analytics if approved
      if (consent.preferences.analytics && !window.plausible) {
        const script = document.createElement('script');
        script.defer = true;
        script.dataset.domain = 'codariq.de';
        script.src = 'https://plausible.io/js/script.js';
        document.head.appendChild(script);
      }

      // Enable Calendly if marketing cookies approved
      if (consent.preferences.marketing) {
        // Calendly is loaded on-demand in FinalCTA component
        window.calendlyAllowed = true;
      }
    }
  }

  // Initialize when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    new CookieConsent();
  });
</script>

<style>
  .toggle-bg {
    transition: background-color 0.2s ease;
  }

  .toggle-dot {
    transition: transform 0.2s ease;
  }

  #cookie-consent {
    box-shadow:
      0 -4px 6px -1px rgba(0, 0, 0, 0.1),
      0 -2px 4px -1px rgba(0, 0, 0, 0.06);
  }
</style>
